# 멀티 프로세서 스케줄링 (고급)

## 멀티프로세서 스케줄링의 필요성
예전에는 하나의 CPU만 사용했지만, 이제는 여러 개의 CPU 코어가 하나의 칩에 내장된 멀티코어 시스템이 보편화되었다.
  
대부분의 기존 프로그램은 하나의 CPU만 사용 → 성능 향상을 위해 응용 프로그램을 병렬로 실행되도록 작성해야 한다.

멀티스레드 프로그램은 여러 CPU에서 동시에 실행될 수 있어야 한다.

운영체제 또한 여러 CPU에 효율적으로 작업을 배치할 수 있도록 스케줄링 방법이 필요하다.

<br>

## 1. 멀티프로세서 구조
(1) 단일 CPU
단일 CPU에서는 하드웨어 캐시 계층이 존재한다. 캐시만 잘 관리하면 성능이 향상된다.

캐시는 지역성에 기반한다. 지역성 = 시간 지역성 + 공간 지역성

(2) 멀티 CPU

멀티 CPU에서는 캐시 일관성(cache coherence) 문제 발생: CPU 1이 데이터를 변경해도, CPU 2는 변경 전 데이터를 참조할 수 있음.

해결: 하드웨어가 일관성을 보장하는 버스 스누핑(bus snooping) 등 사용.

캐시는 자신과 메모리를 연결하는 버스의 통신 상황을 계속 모니터링한다. 캐시 데이터에 대한 변경이 발생하면, 자신의 복사본을 무효화시키거나 갱신한다. 

나중 쓰기 캐시는 메인 메이모리에 쓰기 연산이 지연되기 때문에 캐시 일관성 유지 문제를 훨씬 복잡하게 만든다.

<br>

## 2. 동기화의 중요성
캐시 일관성이 있다고 해도 동시 접근으로 인해 논리적인 충돌이 발생할 수 있음.

예시: 연결 리스트에서 동시에 원소 하나를 삭제 시도 → 데이터 중복 삭제.

해결: 락(mutex) 같은 동기화 메커니즘 필요하다.

고성능이 요구되면 락-프리(lock-free) 기법도 고려되지만 복잡하다.

락 프리 방식이란 공유 자원을 보호할 때 락(mutex 등)을 사용하지 않고, 충돌 없이 스레드들이 동시에 접근할 수 있게 하는 방식이다.

<br>

## 3. 캐시 친화성 (Cache Affinity)
동일한 CPU에서 계속 실행되면 캐시에 정보가 남아 성능이 좋다.

반면 프로세스가 여러 CPU를 돌아다니면 매번 캐시가 초기화되어 성능 저하된다.

따라서 멀티 프로세서 스케줄러는 스케줄링 결정을 내릴 때 캐시 친화성을 고려하여 가능한 한 같은 CPU에서 재실행되도록 고려해야 한다.

<br>

## 4. 단일 큐 스케줄링 (SQMS)
하나의 큐로 여러 CPU가 작업을 가져간다.

장점: 구현이 간단하다.

단점:

(1) 확장성 : 코드에 일정 형태의 락을 삽입히야 한다. 락은 성능을 크게 저하시킬 수 있다.

(2) 캐시 친화성이 좋지 않다. : 각 CPU는 공유 큐에서 다음 작업을 선택하기 때문에 각 작업은 CPU를 옮겨 다니게 된다.

<br>

## 5. 멀티 큐 스케줄링 (MQMS)
CPU마다 독립적인 큐를 둔다. 

장점: 락 경쟁이 줄어들고 캐시 친화성도 좋다.

단점: 워크로드의 불균형

-> 이주 migration : 오버헤드 불균형을 줄이기 위해서이다. 작업을 한 CPU에서 다른 CPU로 이주시킴으로써 워크로드 균형을 이룬다.

-> 가장 기본적인 접근 방식 : 작업 훔치기(work stealing) 


